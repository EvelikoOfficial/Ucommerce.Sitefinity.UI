@model dynamic

@using Telerik.Sitefinity.Frontend.Mvc.Helpers
@using Telerik.Sitefinity.Services;
@using Ucommerce.Sitefinity.UI.Mvc.Model;
@using Ucommerce.Sitefinity.UI.Mvc.ViewModels;

@Html.StyleSheet(Url.WidgetContent("assets/src/css/uc-vue-styles.css"), "head")
@Html.StyleSheet(Url.WidgetContent("assets/src/css/uc-quantum.css"), "head")

@helper DisplayCategories(IList<CategoryNavigationCategoryViewModel> categories, bool topLevel)
{
    var categoryClass = "category-parent";
    if (!topLevel)
    {
        categoryClass = "category-child closed";
    }

    <ul class=" @categoryClass">
        @foreach (var category in categories)
        {
            var selected = category.IsActive ? "selected" : "";
            var categoryHref = category.Url;
            <li class="@selected">

                @if (category.Categories.Count > 0)
                {
                    categoryHref = "";
                }
                <a style="" href="@categoryHref">
                    @category.DisplayName
                    @if (topLevel && category.Categories.Count > 0)
                    {
                        <i class="fa fa-chevron-down"></i>
                    }
                    @if (!topLevel && category.Categories.Count > 0)
                    {
                        <i class="fa fa-chevron-right"></i>
                    }
                </a>

                @if (category.Categories.Count > 0)
                {
                    @DisplayCategories(category.Categories, false)
                }
            </li>
        }
    </ul>
}

<header class="top top--light" ng-controller="categoryNavigationController">
    <div class="top-inner top-inner--center">
        <nav class="logo-wrap">
            <a href="/" class="logo logo--on-light" alt="">
                <img src="@Model.ImageUrl" alt="">
            </a>
        </nav>

        @if (Model.Categories.Count > 0)
        {
            <nav class="main-nav">
                @DisplayCategories(Model.Categories, true)
            </nav>
        }
        <nav class="main-nav main-nav--right hide--m">
            <ul>
                @if (Model.AllowChangingCurrency && Model.Currencies.Count > 0)
                {
                    <li class="lang currency">
                        @if (Model.CurrentCurrency != null)
                        {
                            <a class="ng-binding">
                                <span style="display: inline-block;" class="ng-scope">@Model.CurrentCurrency.DisplayName</span><i class="fa fa-chevron-down"></i>
                            </a>
                        }
                        <ul>
                            @foreach (var currency in Model.Currencies)
                            {
                                <li><a href="" ng-click="basketService.setCurrency('@currency.PriceGroupId')"><span>@currency.DisplayName</span></a></li>
                            }
                        </ul>
                    </li>
                }
                <li class="toggle-search" ng-click="searchService.toggleSearchBar()"><a href=""><i class="fa fa-search"></i></a></li>

                @if (!Model.HideMiniBasket && !SystemManager.IsDesignMode)
                {
                    <li class="toggle-cart" ng-click="basketService.toggleSideBarBasket()" ng-class="{'active' : basketService.basket.orderLines.length > 0}">
                        <a href="">
                            <span>
                                <span class="">{{basketService.basket.NumberOfItemsInBasket}}</span>
                                <i class="fa fa-shopping-cart"></i>
                            </span>
                        </a>
                    </li>
                }
            </ul>
        </nav>
    </div>
</header>

<div class="search" ng-controller="fullTextSearchController">

    <button class="search__close" ng-click="searchService.toggleSearchBar()"><i class="fa fa-times"></i></button>

    <div class="search__stage">

        @if (Model.SearchPageUrl != null)
        {
            <form action="@Model.SearchPageUrl" class="search__form" _lpchecked="1">
                <i class="fa fa-search"></i>
                <input type="text" autocomplete="off" ng-model="searchService.searchQuery" focus ng-change="searchService.search()" required="" name="search" class="search__input ng-pristine ng-empty ng-invalid ng-invalid-required ng-touched" placeholder="Search for products">
            </form>
        }
        else
        {
            <form class="search__form" _lpchecked="1">
                <i class="fa fa-search"></i>
                <input type="text" autocomplete="off" ng-model="searchService.searchQuery" autofocus ng-change="searchService.search()" required="" name="search" class="search__input ng-pristine ng-empty ng-invalid ng-invalid-required ng-touched" placeholder="Search for products">
            </form>
        }

        <div class="search__autocomplete" ng-hide="searchService.searchResult.length == 0 && searchService.suggestion.length == 0">
            <ul class="search__suggest">
                <li ng-repeat="suggestion in searchService.suggestions" class="ng-scope" ng-click="searchService.searchQuery = suggestion;searchService.search()">
                    <span class="search__suggest-image">
                    </span>
                    <span class="search__suggest-info">
                        <span class="search__suggest-title ng-binding">{{suggestion}}</span>
                    </span>
                </li>
                <li ng-repeat="product in searchService.searchResult" class="ng-scope">
                    <a href="{{product.Url}}">
                        <span class="search__suggest-image">
                            <img ng-src="{{product.ThumbnailImageUrl}}" alt="">
                        </span>
                        <span class="search__suggest-info">
                            <span class="search__suggest-title ng-binding">{{product.Name}}</span>
                        </span>
                    </a>
                </li>
            </ul>
            @if (Model.SearchPageUrl != null)
            {
                <a href="@Model.SearchPageUrl?search={{searchService.searchQuery}}" class="button button--block">Show all results</a>
            }
        </div>
    </div>

</div>

<script>
    (function () {
        var categories = document.querySelectorAll('.category-parent > li');

        for (var i = 0; i < categories.length; i++) {
            categories[i].addEventListener('click', function () {

                var children = this.children;
                var otherChildren = document.querySelectorAll('.category-child');
                for (var i = 0; i < children.length; i++) {

                    if (children[i].classList.contains('closed')) {

                        for (var j = 0; j < otherChildren.length; j++) {

                            if (otherChildren[j].classList.contains('open')) {
                                otherChildren[j].classList.remove("open");
                                otherChildren[j].classList.add("closed");
                            }
                        }

                        this.children[i].classList.remove("closed");
                        this.children[i].classList.add("open");
                    } else if (children[i].classList.contains('open')) {

                        var otherChildren = document.querySelectorAll('.category-child');
                        for (var j = 0; j < otherChildren.length; j++) {

                            if (otherChildren[j].classList.contains('open')) {
                                otherChildren[j].classList.remove("open");
                                otherChildren[j].classList.add("closed");
                            }
                        }
                    }
                }
            }, false);
        }
    });
</script>
